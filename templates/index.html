<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EliteStay Uzbekistan | Premium Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary-blue: #2563eb; --dark-slate: #1e293b; --success-green: #10b981; }
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; color: #334155; }

        /* Hero qismi */
        .hero {
            background: linear-gradient(rgba(30, 41, 59, 0.8), rgba(30, 41, 59, 0.9)), url('https://images.unsplash.com/photo-1542314831-068cd1dbfeeb?auto=format&fit=crop&w=1920&q=80');
            background-size: cover; background-position: center; padding: 100px 0; color: white; text-align: center;
        }

        /* Kartochkalar dizayni */
        .region-card, .hotel-card {
            border-radius: 20px; overflow: hidden; cursor: pointer; transition: 0.3s;
            border: none; background: white; position: relative; height: 100%; box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        .region-card:hover, .hotel-card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .region-card img { width: 100%; height: 350px; object-fit: cover; }

        /* Carousel dizayni */
        .hotel-carousel img { width: 100%; height: 250px; object-fit: cover; }
        .carousel-control-prev, .carousel-control-next { width: 40px; height: 40px; background: rgba(0,0,0,0.5); border-radius: 50%; top: 50%; transform: translateY(-50%); margin: 0 10px; }

        .region-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 10%, transparent 70%);
            display: flex; align-items: flex-end; padding: 25px; color: white;
        }

        .hidden { display: none !important; }

        /* Ma'lumot yo'qligi uchun dizayn */
        .no-data {
            text-align: center; padding: 50px; background: white; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* Muvaffaqiyat oynasi */
        .success-card {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 9999; background: white; padding: 40px; border-radius: 30px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.2); text-align: center; display: none; width: 90%; max-width: 450px;
        }

        /* Lokatsiya va Tavsif uchun qo'shimcha stil */
        .desc-text { font-size: 0.9rem; line-height: 1.4; color: #64748b; margin-bottom: 15px; }
        .location-badge { font-size: 0.8rem; background: #e2e8f0; color: #475569; padding: 5px 12px; border-radius: 50px; display: inline-block; margin-bottom: 10px; text-decoration: none; transition: 0.2s; }
        .location-badge:hover { background: #cbd5e1; color: #1e293b; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">EliteStay <span class="text-primary">UZ</span></a>
            <div id="authButtons" class="d-flex align-items-center gap-2">
                <button id="logoutBtn" class="btn btn-outline-danger btn-sm rounded-pill hidden" onclick="logout()">Chiqish</button>
                <button id="loginTriggerBtn" class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#authModal">Kirish</button>
            </div>
        </div>
    </nav>

    <header class="hero">
        <div class="container">
            <h1 class="display-3 fw-bold mb-3">O'zbekistonni Biz Bilan Kashf qiling</h1>
            <p class="lead opacity-75">Eng hashamatli mehmonxonalar va dam olish maskunlari</p>
        </div>
    </header>

    <main class="container my-5">
        <section id="rSection">
            <h2 class="fw-bold mb-4"><i class="fas fa-map-marker-alt text-primary me-2"></i>Viloyatni tanlang</h2>
            <div class="row g-4" id="regionGrid"></div>
        </section>

        <section id="hSection" class="hidden">
            <div class="d-flex justify-content-between align-items-center mb-5 pb-3 border-bottom">
                <h2 class="fw-bold m-0" id="hTitle">Maskunlar</h2>
                <button class="btn btn-dark rounded-pill px-4" onclick="closeHotels()">
                    <i class="fas fa-arrow-left me-2"></i>Orqaga
                </button>
            </div>
            <div class="row g-4" id="hotelGrid"></div>
        </section>
    </main>

    <div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4 border-0 shadow-lg" style="border-radius: 25px;">
                <div id="authEmailStep">
                    <h3 class="fw-bold text-center mb-4">Xush kelibsiz!</h3>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Email manzilingiz</label>
                        <input type="email" id="authEmail" class="form-control form-control-lg rounded-4" placeholder="email@gmail.com">
                    </div>
                    <button class="btn btn-primary w-100 btn-lg rounded-pill" onclick="handleSendOTP()">Tasdiqlash kodini yuborish</button>
                </div>
                <div id="authOTPStep" class="hidden text-center">
                    <h3 class="fw-bold mb-3">Kodni tasdiqlang</h3>
                    <p class="text-muted small mb-4">Emailingizga yuborilgan 5 xonali kodni kiriting</p>
                    <input type="text" id="authOTP" class="form-control form-control-lg text-center mb-4 rounded-4 fw-bold" maxlength="5" style="letter-spacing: 10px; font-size: 2rem;">
                    <button class="btn btn-success w-100 btn-lg rounded-pill" onclick="handleVerifyOTP()">Kirishni yakunlash</button>
                    <button class="btn btn-link w-100 mt-2 text-decoration-none text-muted" onclick="toggleAuthSteps(true)">Orqaga qaytish</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4 border-0 shadow-lg" style="border-radius: 25px;">
                <h3 class="fw-bold mb-4">Bronni rasmiylashtirish</h3>
                <div class="row g-3">
                    <div class="col-6">
                        <label class="small fw-bold">Kelish sanasi</label>
                        <input type="date" id="checkIn" class="form-control rounded-4" onchange="setMinCheckOut()">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold">Ketish sanasi</label>
                        <input type="date" id="checkOut" class="form-control rounded-4">
                    </div>
                    <div class="col-12">
                        <label class="small fw-bold">Mehmonlar soni</label>
                        <input type="number" id="guestCount" class="form-control rounded-4" value="1" min="1">
                    </div>
                </div>
                <button class="btn btn-primary w-100 btn-lg rounded-pill mt-4" onclick="confirmBooking()">Bronni tasdiqlash</button>
            </div>
        </div>
    </div>

    <div id="successCard" class="success-card">
        <div class="mb-4"><i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i></div>
        <h2 class="fw-bold">Muvaffaqiyatli!</h2>
        <p class="text-muted">Sizning buyurtmangiz qabul qilindi.</p>
        <div class="bg-light p-3 rounded-4 mb-4">
            <span class="small text-muted d-block">Buyurtma raqami:</span>
            <span id="bookingId" class="h4 fw-bold text-primary"></span>
        </div>
        <button class="btn btn-dark w-100 rounded-pill py-2" onclick="location.reload()">Yopish</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = "http://127.0.0.1:8000/api";
        let currentRegionId = null;
        let currentHotelId = null;

        // --- SANA CHEKLOVI ---
        function setMinDates() {
            const today = new Date().toISOString().split('T')[0];
            const checkIn = document.getElementById('checkIn');
            const checkOut = document.getElementById('checkOut');
            if(checkIn) checkIn.setAttribute('min', today);
            if(checkOut) checkOut.setAttribute('min', today);
        }

        function setMinCheckOut() {
            const checkInVal = document.getElementById('checkIn').value;
            document.getElementById('checkOut').setAttribute('min', checkInVal);
        }

        // --- AUTH LOGIC ---
        function toggleAuthSteps(toEmail) {
            document.getElementById('authEmailStep').classList.toggle('hidden', !toEmail);
            document.getElementById('authOTPStep').classList.toggle('hidden', toEmail);
        }

        async function handleSendOTP() {
            const email = document.getElementById('authEmail').value;
            if(!email) { alert("Email manzilingizni kiriting!"); return; }
            try {
                const res = await fetch(`${API_URL}/auth/send-otp/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email})
                });
                if (res.ok) toggleAuthSteps(false);
                else alert("Xatolik yuz berdi!");
            } catch (err) { alert("Server bilan bog'lanishda xato!"); }
        }

        async function handleVerifyOTP() {
            const email = document.getElementById('authEmail').value;
            const otp = document.getElementById('authOTP').value;
            try {
                const res = await fetch(`${API_URL}/auth/verify-otp/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, otp})
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    location.reload();
                } else alert("Kod noto'g'ri!");
            } catch (err) { alert("Xatolik yuz berdi!"); }
        }

        function logout() { localStorage.removeItem('token'); location.reload(); }

        // --- MA'LUMOTLARNI YUKLASH ---
        async function loadRegions() {
            try {
                const res = await fetch(`${API_URL}/regions/`);
                const data = await res.json();
                const regions = data.results || data;
                const grid = document.getElementById('regionGrid');

                if (!regions || regions.length === 0) {
                    grid.innerHTML = `<div class="col-12"><div class="no-data"><i class="fas fa-map-marked-alt fa-3x mb-3 text-muted"></i><h3>Hozircha viloyatlar mavjud emas</h3></div></div>`;
                    return;
                }

                grid.innerHTML = regions.map(r => `
                    <div class="col-lg-4 col-md-6">
                        <div class="card region-card shadow-sm" onclick="openHotels(${r.id}, '${r.name}')">
                            <img src="${r.image || 'https://via.placeholder.com/800x600'}" alt="${r.name}">
                            <div class="region-overlay">
                                <div>
                                    <h3 class="fw-bold m-0">${r.name}</h3>
                                    ${r.location ? `<small class="d-block"><i class="fas fa-map-pin"></i> ${r.location}</small>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) { console.error(err); }
        }

        async function openHotels(regionId, regionName) {
            currentRegionId = regionId;
            document.getElementById('rSection').classList.add('hidden');
            document.getElementById('hSection').classList.remove('hidden');
            document.getElementById('hTitle').innerText = regionName;

            try {
                const res = await fetch(`${API_URL}/regions/${regionId}/districts/`);
                const data = await res.json();
                const hotels = data.results || data;
                const grid = document.getElementById('hotelGrid');

                if (!hotels || hotels.length === 0) {
                    grid.innerHTML = `<div class="col-12"><div class="no-data"><i class="fas fa-hotel fa-3x mb-3 text-muted"></i><h3>Ushbu viloyatda maskunlar hali qo'shilmagan</h3><button class="btn btn-outline-primary mt-3" onclick="closeHotels()">Orqaga qaytish</button></div></div>`;
                    return;
                }

                grid.innerHTML = hotels.map(h => {
                    // Carousel (Multiple Images) Logic
                    let carouselHtml = '';
                    if(h.images && h.images.length > 0) {
                        const items = h.images.map((img, index) => `
                            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                <img src="${img.image}" class="d-block w-100 hotel-img" alt="image">
                            </div>
                        `).join('');

                        carouselHtml = `
                            <div id="carouselHotel${h.id}" class="carousel slide hotel-carousel" data-bs-ride="carousel">
                                <div class="carousel-inner">${items}</div>
                                ${h.images.length > 1 ? `
                                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselHotel${h.id}" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#carouselHotel${h.id}" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
                                ` : ''}
                            </div>`;
                    } else {
                        carouselHtml = `<img src="${h.image || 'https://via.placeholder.com/800x600'}" class="hotel-img" style="width:100%; height:250px; object-fit:cover;">`;
                    }

                    // --- LOKATSIYA LOGIKASI ---
                    // Agar admin location maydoniga link yoki koordinata qoshgan bolsa, uni xarita tugmasi qilamiz
                    let locationLink = "";
                    if(h.location) {
                        const isLink = h.location.startsWith('http');
                        const finalUrl = isLink ? h.location : `https://www.google.com/maps/search/${encodeURIComponent(h.location)}`;
                        locationLink = `<a href="${finalUrl}" target="_blank" class="location-badge"><i class="fas fa-location-arrow me-1"></i> Xaritada ko'rish</a>`;
                    }

                    return `
                    <div class="col-lg-4 col-md-6">
                        <div class="card hotel-card h-100">
                            ${carouselHtml}
                            <div class="card-body p-4 d-flex flex-column">
                                <div class="mb-2">
                                    <h4 class="fw-bold mb-1">${h.name}</h4>
                                    ${locationLink}
                                </div>
                                <div class="desc-text flex-grow-1">
                                    ${h.description ? h.description.substring(0, 100) + '...' : 'Premium maskun tavsifi mavjud emas.'}
                                </div>
                                <p class="text-muted small mb-3 mt-2"><i class="fas fa-star text-warning me-1"></i> ${h.average_rating || '5.0'}</p>
                                <div class="d-flex justify-content-between align-items-center pt-3 border-top mt-auto">
                                    <span class="h4 fw-bold text-success mb-0">$${h.price_per_night || '0'}</span>
                                    <button class="btn btn-primary rounded-pill px-4" onclick="prepareBooking(${h.id})">Bron qilish</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
                window.scrollTo(0,0);
            } catch (err) { console.error(err); }
        }

        function closeHotels() {
            document.getElementById('rSection').classList.remove('hidden');
            document.getElementById('hSection').classList.add('hidden');
        }

        function prepareBooking(hotelId) {
            currentHotelId = hotelId;
            if (!localStorage.getItem('token')) {
                new bootstrap.Modal(document.getElementById('authModal')).show();
            } else {
                new bootstrap.Modal(document.getElementById('bookingModal')).show();
            }
        }

        async function confirmBooking() {
            const token = localStorage.getItem('token');
            const payload = {
                district: currentHotelId,
                check_in: document.getElementById('checkIn').value,
                check_out: document.getElementById('checkOut').value,
                guests: parseInt(document.getElementById('guestCount').value)
            };

            if(!payload.check_in || !payload.check_out) { alert("Sanalarni tanlang!"); return; }

            try {
                const res = await fetch(`${API_URL}/regions/${currentRegionId}/districts/${currentHotelId}/bookings/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Token ${token}`},
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('bookingModal')).hide();
                    document.getElementById('successCard').style.display = 'block';
                    document.getElementById('bookingId').innerText = "#ES-" + Math.floor(1000 + Math.random() * 9000);
                } else alert("Sanalarda xatolik!");
            } catch (err) { alert("Server xatosi!"); }
        }

        window.onload = () => {
            loadRegions();
            setMinDates();
            const token = localStorage.getItem('token');
            if (token) {
                const logoutBtn = document.getElementById('logoutBtn');
                const loginBtn = document.getElementById('loginTriggerBtn');
                if(logoutBtn) logoutBtn.classList.remove('hidden');
                if(loginBtn) loginBtn.classList.add('hidden');
            }
        }
    </script>
</body>
</html>